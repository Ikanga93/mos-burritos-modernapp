# Environment Setup Guide

This project supports dual authentication and database systems based on the environment:

| Environment | Auth System | Database            |
|-------------|-------------|---------------------|
| Development | JWT         | SQLite              |
| Production  | Supabase    | Supabase PostgreSQL |

## Development Setup

### Backend

1. Copy the development environment template:
```bash
cd backend
cp env.development.example .env
```

2. Update `.env` with your development settings (most defaults work fine)

3. Install dependencies and run:
```bash
pip install -r requirements.txt
uvicorn app.main:app --reload
```

### Frontend

1. Copy the development environment template:
```bash
cp env.development.example .env
```

2. Install dependencies and run:
```bash
npm install
npm run dev
```

## Production Setup

### Prerequisites

1. Create a Supabase account at https://supabase.com
2. Create a new Supabase project
3. Note down your project credentials:
   - Project URL: `https://[PROJECT-REF].supabase.co`
   - Anon (public) key
   - Service role (secret) key
   - Database password

### Backend

1. Copy the production environment template:
```bash
cd backend
cp env.production.example .env
```

2. Update `.env` with your Supabase credentials:
   - `DATABASE_URL`: PostgreSQL connection string from Supabase
   - `SUPABASE_URL`: Your project URL
   - `SUPABASE_ANON_KEY`: Your anon key
   - `SUPABASE_SERVICE_KEY`: Your service role key
   - `JWT_SECRET_KEY`: Generate a strong secret key
   - `STRIPE_SECRET_KEY`: Your Stripe live key
   - `FRONTEND_URL`: Your production frontend URL
   - `CORS_ORIGINS`: Your production domain(s)

3. Run database migrations:
```bash
# This will create tables in your Supabase PostgreSQL database
python -m alembic upgrade head
```

4. (Optional) Migrate existing data from SQLite:
```bash
python scripts/migrate_to_supabase.py
```

### Frontend

1. Copy the production environment template:
```bash
cp env.production.example .env.production
```

2. Update `.env.production` with your settings:
   - `VITE_API_URL`: Your production backend URL
   - `VITE_SUPABASE_URL`: Your Supabase project URL
   - `VITE_SUPABASE_ANON_KEY`: Your Supabase anon key

3. Build for production:
```bash
npm run build
```

## Environment Variables Reference

### Backend Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `ENVIRONMENT` | Yes | `development` or `production` |
| `DATABASE_URL` | Yes | Database connection string |
| `JWT_SECRET_KEY` | Yes | Secret key for JWT tokens |
| `STRIPE_SECRET_KEY` | Yes | Stripe API key |
| `STRIPE_WEBHOOK_SECRET` | Yes | Stripe webhook signing secret |
| `FRONTEND_URL` | Yes | Frontend URL for CORS and redirects |
| `CORS_ORIGINS` | Yes | Comma-separated allowed origins |
| `SUPABASE_URL` | Prod only | Supabase project URL |
| `SUPABASE_ANON_KEY` | Prod only | Supabase anon key |
| `SUPABASE_SERVICE_KEY` | Prod only | Supabase service role key |

### Frontend Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `VITE_ENVIRONMENT` | Yes | `development` or `production` |
| `VITE_API_URL` | Yes | Backend API URL |
| `VITE_SUPABASE_URL` | Prod only | Supabase project URL |
| `VITE_SUPABASE_ANON_KEY` | Prod only | Supabase anon key |

## How It Works

### Development Mode (`ENVIRONMENT=development`)

- **Authentication**: Uses JWT tokens generated by FastAPI
- **Database**: Local SQLite database (`mos_burritos.db`)
- **Auth Flow**: 
  1. User logs in via `/auth/login`
  2. Backend validates credentials against SQLite
  3. Returns JWT access and refresh tokens
  4. Frontend stores tokens in localStorage
  5. Subsequent requests include JWT in Authorization header

### Production Mode (`ENVIRONMENT=production`)

- **Authentication**: Uses Supabase Auth
- **Database**: Supabase PostgreSQL
- **Auth Flow**:
  1. User logs in via `/auth/login`
  2. Backend validates credentials against Supabase Auth
  3. Returns Supabase session tokens
  4. Backend syncs user data to PostgreSQL database
  5. Frontend stores tokens and uses Supabase client
  6. Subsequent requests include Supabase token in Authorization header

## Switching Between Environments

Simply change the `ENVIRONMENT` variable in your `.env` file:

```bash
# For development
ENVIRONMENT=development

# For production
ENVIRONMENT=production
```

The application automatically detects the environment and uses the appropriate auth and database systems.

## Testing Production Mode Locally

You can test production mode locally by:

1. Setting up Supabase credentials in backend `.env`
2. Setting `ENVIRONMENT=production`
3. Starting the backend
4. Setting frontend environment to production
5. Testing the complete flow

This is useful for testing the Supabase integration before actual deployment.
