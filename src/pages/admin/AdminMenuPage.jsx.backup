import React, { useState, useEffect } from 'react'
import { Plus, Edit2, Trash2, X, Check, DollarSign, ToggleLeft, ToggleRight } from 'lucide-react'
import { useAdminAuth } from '../../contexts/AdminAuthContext'
import { useToast } from '../../contexts/ToastContext'
import { menuApi } from '../../services/api/menuApi'
import { locationApi } from '../../services/api/locationApi'
import LoadingSpinner from '../../components/shared/LoadingSpinner'
import './AdminMenuPage.css'

const AdminMenuPage = () => {
    const { isAuthenticated, isLoading: authLoading, role, assignedLocations, currentLocation } = useAdminAuth()
    const { showToast } = useToast()

    const [locations, setLocations] = useState([])
    const [selectedLocation, setSelectedLocation] = useState('')
    const [menuItems, setMenuItems] = useState([])
    const [categories, setCategories] = useState([])
    const [isLoading, setIsLoading] = useState(true)
    const [showModal, setShowModal] = useState(false)
    const [editingItem, setEditingItem] = useState(null)
    const [formData, setFormData] = useState({
        name: '', description: '', price: '', category_id: '', is_available: true, image_url: ''
    })

    const isManager = ['owner', 'manager'].includes(role)
    const isOwner = role === 'owner'

    useEffect(() => {
        if (!authLoading && isAuthenticated) loadLocations()
    }, [authLoading, isAuthenticated])

    // Sync selectedLocation with currentLocation from context for non-owners
    useEffect(() => {
        if (!isOwner && currentLocation) {
            setSelectedLocation(currentLocation.id)
        } else if (isOwner && locations.length > 0 && !selectedLocation) {
            setSelectedLocation(locations[0].id)
        }
    }, [isOwner, currentLocation, locations, selectedLocation])

    const loadLocations = async () => {
        try {
            const data = await locationApi.getAllLocations()
            const locs = Array.isArray(data) ? data : data.locations || []
            setLocations(locs)
            if (locs.length > 0 && !selectedLocation) setSelectedLocation(locs[0].id)
        } catch (error) {
            console.error('Error loading locations:', error)
        }
    }

    useEffect(() => {
        if (selectedLocation) loadMenu()
    }, [selectedLocation])

    const loadMenu = async () => {
        setIsLoading(true)
        try {
            const [itemsData, categoriesData] = await Promise.all([
                menuApi.getMenuItems(selectedLocation),
                menuApi.getCategories(selectedLocation)
            ])
            setMenuItems(Array.isArray(itemsData) ? itemsData : itemsData.items || [])
            setCategories(Array.isArray(categoriesData) ? categoriesData : categoriesData.categories || [])
        } catch (error) {
            console.error('Error loading menu:', error)
            showToast('Failed to load menu', 'error')
        } finally {
            setIsLoading(false)
        }
    }

    const openAddModal = () => {
        setEditingItem(null)
        setFormData({ name: '', description: '', price: '', category_id: categories[0]?.id || '', is_available: true, image_url: '' })
        setShowModal(true)
    }

    const openEditModal = (item) => {
        setEditingItem(item)
        setFormData({
            name: item.name || '', description: item.description || '', price: item.price?.toString() || '',
            category_id: item.category_id || '', is_available: item.is_available !== false, image_url: item.image_url || ''
        })
        setShowModal(true)
    }

    const closeModal = () => { setShowModal(false); setEditingItem(null) }

    const handleSubmit = async (e) => {
        e.preventDefault()
        if (!formData.name.trim() || !formData.price) {
            showToast('Name and price are required', 'error')
            return
        }
        try {
            const itemData = { ...formData, price: parseFloat(formData.price), location_id: selectedLocation }
            if (editingItem) {
                await menuApi.updateMenuItem(editingItem.id, itemData)
                showToast('Item updated successfully', 'success')
            } else {
                await menuApi.createMenuItem(itemData)
                showToast('Item created successfully', 'success')
            }
            closeModal()
            loadMenu()
        } catch (error) {
            showToast(error.message || 'Failed to save item', 'error')
        }
    }

    const handleDelete = async (itemId) => {
        if (!confirm('Are you sure you want to delete this item?')) return
        try {
            await menuApi.deleteMenuItem(itemId)
            showToast('Item deleted', 'success')
            loadMenu()
        } catch (error) {
            showToast('Failed to delete item', 'error')
        }
    }

    const toggleAvailability = async (item) => {
        try {
            await menuApi.toggleItemAvailability(item.id)
            showToast(`Item ${item.is_available ? 'disabled' : 'enabled'}`, 'success')
            loadMenu()
        } catch (error) {
            showToast('Failed to update item', 'error')
        }
    }

    const groupedItems = categories.map(cat => ({ category: cat, items: menuItems.filter(item => item.category_id === cat.id) }))

    if (authLoading || (isLoading && !menuItems.length)) {
        return <div className="admin-menu-page"><LoadingSpinner size="large" message="Loading menu..." /></div>
    }

    return (
        <div className="admin-menu-page">
            <header className="page-header">
                <div className="header-left">
                    <h1>Menu</h1>
                    {isOwner && (
                        <select value={selectedLocation} onChange={e => setSelectedLocation(e.target.value)} className="location-select">
                            {locations.map(loc => <option key={loc.id} value={loc.id}>{loc.name}</option>)}
                        </select>
                    )}
                    {!isOwner && currentLocation && (
                        <span className="current-location-badge">{currentLocation.name}</span>
                    )}
                </div>
                {isManager && <button className="add-btn" onClick={openAddModal}><Plus size={18} /> Add Item</button>}
            </header>

            {groupedItems.length === 0 || menuItems.length === 0 ? (
                <div className="empty-state">
                    <DollarSign size={48} />
                    <p>No menu items yet</p>
                    {isManager && <button className="add-btn" onClick={openAddModal}>Add Your First Item</button>}
                </div>
            ) : (
                <div className="menu-sections">
                    {groupedItems.map(({ category, items }) => items.length > 0 && (
                        <section key={category.id} className="menu-section">
                            <h2>{category.name}</h2>
                            <div className="items-grid">
                                {items.map(item => (
                                    <div key={item.id} className={`menu-item-card ${!item.is_available ? 'unavailable' : ''}`}>
                                        {item.image_url && <div className="item-image"><img src={item.image_url} alt={item.name} /></div>}
                                        <div className="item-content">
                                            <div className="item-header">
                                                <h3>{item.name}</h3>
                                                <span className="item-price">${parseFloat(item.price).toFixed(2)}</span>
                                            </div>
                                            {item.description && <p className="item-desc">{item.description}</p>}
                                            {isManager && (
                                                <div className="item-actions">
                                                    <button className={`toggle-btn ${item.is_available ? 'on' : 'off'}`} onClick={() => toggleAvailability(item)}>
                                                        {item.is_available ? <ToggleRight size={20} /> : <ToggleLeft size={20} />}
                                                    </button>
                                                    <button className="edit-btn" onClick={() => openEditModal(item)}><Edit2 size={16} /></button>
                                                    <button className="delete-btn" onClick={() => handleDelete(item.id)}><Trash2 size={16} /></button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    ))}
                </div>
            )}

            {showModal && (
                <div className="modal-overlay" onClick={closeModal}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>{editingItem ? 'Edit Item' : 'Add Item'}</h2>
                            <button className="close-btn" onClick={closeModal}><X size={20} /></button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Name *</label>
                                <input type="text" value={formData.name} onChange={e => setFormData({ ...formData, name: e.target.value })} required />
                            </div>
                            <div className="form-group">
                                <label>Description</label>
                                <textarea value={formData.description} onChange={e => setFormData({ ...formData, description: e.target.value })} rows={3} />
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label>Price *</label>
                                    <input type="number" step="0.01" value={formData.price} onChange={e => setFormData({ ...formData, price: e.target.value })} required />
                                </div>
                                <div className="form-group">
                                    <label>Category</label>
                                    <select value={formData.category_id} onChange={e => setFormData({ ...formData, category_id: e.target.value })}>
                                        {categories.map(cat => <option key={cat.id} value={cat.id}>{cat.name}</option>)}
                                    </select>
                                </div>
                            </div>
                            <div className="form-group">
                                <label>Image URL</label>
                                <input type="url" value={formData.image_url} onChange={e => setFormData({ ...formData, image_url: e.target.value })} />
                            </div>
                            <div className="form-group checkbox-group">
                                <label><input type="checkbox" checked={formData.is_available} onChange={e => setFormData({ ...formData, is_available: e.target.checked })} /> Available</label>
                            </div>
                            <div className="modal-actions">
                                <button type="button" className="cancel-btn" onClick={closeModal}>Cancel</button>
                                <button type="submit" className="save-btn"><Check size={18} /> {editingItem ? 'Update' : 'Create'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    )
}

export default AdminMenuPage
